<style>
	.mat1 {
		--color: pink;
		--metalness: 0.5;
		--roughness: 0.5;
	}
</style>

<style>
	@import url("./style.css");
</style>

<script type="importmap">
	{
		"imports": {
			"three": "https://cdn.jsdelivr.net/npm/three@0.141.0/build/three.module.js",
			"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.141.0/examples/jsm/",
			"three-webc": "../src/index.js",
			"three-webc/": "../"
		}
	}
</script>

<gui-info>
	<p>CSS example</p>
</gui-info>

<t-renderer orbit>
	<!-- <t-camera :position="{ x: 4, y:4, z: 4 }"></t-camera> -->
	<t-light type="AmbientLight"></t-light>
	<t-light type="DirectionalLight"></t-light>
	<t-light type="SpotLight"></t-light>
	<t-floor></t-floor>
	<t-mesh :position="{ y: 1.5 }" :props="{castShadow: true}">
		<t-geometry type="Sphere"></t-geometry>
		<t-material class="mat1" type="MeshStandard"></t-material>
	</t-mesh>
	<t-mesh gui :position="{ x: 3, y: 1.5 }" :props="{castShadow: true}">
		<t-geometry type="Sphere"></t-geometry>
		<t-material
			type="MeshStandard"
			style="--color: green; --metalness: 0.5"
		></t-material>
	</t-mesh>
</t-renderer>

<script type="module">
	import { ThreeWebc } from "three-webc";
	import "three-webc/addons/index.js";
	import "three-webc/addons/objects/floor.js";

	{
		const { ObjectGui } = await import("three-webc/addons/gui/index.js");
		const { GUI } = await import(
			"https://cdn.jsdelivr.net/npm/lil-gui@0.17/+esm"
		);
		const gui = new GUI();

		new ObjectGui(document.querySelector('[gui]')).addTo(gui);
	}

	const KEYS = ["color", "metalness", "roughness"];

	const applyStylesAndWatch = (element, keys = KEYS) => {
		applyStyles(element, keys);
		// Add to inline style to observe
		setToStyle(element, keys);
		watchInlineStyles(element, keys);
	};

	const setToStyle = (element, keys = KEYS) => {
		const rules = keys.map((key) => `--${key}: ${element[key]}`);
		element.setAttribute("style", rules.join(";"));
		// element.setAttribute("style", `--color: ${element['color']}; --metalness: ${element['metalness']}`);
	};

  const applyAttributeToMaterial = (material, key, value) => {
    console.log(material, key)

		if (!material[key]) {
      console.warn(`key ${key} not found`)
      return
    }

    if (material[key]?.set) {
      material[key].set(value);
      return true
    }

    material[key] = value
	};

	const applyStyles = (element, keys = KEYS) => {
		const styles = getComputedStyle(element);

		keys.forEach((key) => {
			const property = `--${key}`;
			const value = styles.getPropertyValue(property);

			// Apply
      console.log(value)
			element[key] = value.trim();

      // directly to material
      applyAttributeToMaterial(element.material, key, value.trim())
		});
	};

	const watchInlineStyles = (element, keys = KEYS) => {
		observeAttributeChange(element, (prop, value, { target }) => {
			applyStyles(element, keys);
		});
	};

	export const observeAttributeChange = (
		el,
		callback = (prop = "", value) => {}
	) => {
		const observer = new MutationObserver((mutations) => {
			mutations.forEach((mutation) => {
				if (mutation.type === "attributes") {
					const element = mutation.target;
					const name = mutation.attributeName;
					const newValue = element.getAttribute(name);

					callback(name, newValue, mutation);
				}
			});
		});

		observer.observe(el, { attributes: true, attributeFilter: ["style"] });

		return observer;
	};

	[...document.querySelectorAll("t-material[style]")].forEach((el) =>
		applyStylesAndWatch(el)
	);

	applyStylesAndWatch(document.querySelector(".mat1"), KEYS);
</script>
